name: Wait for Lock to Clear

on:
  pull_request:

jobs:
  wait-for-lock:
    runs-on: ubuntu-latest
    steps:
      - name: Poll until lock is released (max 5 minutes)
        id: wait-for-unlock
        run: |
          echo "Starting lock check loop..."
        shell: bash

      - name: Check lock in loop
        uses: github/lock@v2
        with:
          environment: release
          check: true
          continue-on-error: true
        id: lock-check

      - name: Handle lock status
        run: |
          if [[ "${{ steps.lock-check.outputs.locked }}" == "true" ]]; then
            echo "Still locked, waiting..."
            exit 1
          else
            echo "Lock is free. Continuing."
            exit 0
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
